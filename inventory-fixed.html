<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜åˆ—è¡¨ - ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">ä»“åº“ç®¡ç†ç³»ç»Ÿ</a>
            <div class="navbar-nav">
                <a class="nav-link" href="index.html">é¦–é¡µ</a>
                <a class="nav-link active" href="inventory-fixed.html">åº“å­˜åˆ—è¡¨</a>
                <a class="nav-link" href="stock-in.html">å•†å“å…¥åº“</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2>åº“å­˜åˆ—è¡¨</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢å•†å“åç§°æˆ–SKU">
                            </div>
                            <div class="col-md-2">
                                <select class="form-control" id="categoryFilter">
                                    <option value="">æ‰€æœ‰ç±»åˆ«</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-control" id="stockFilter">
                                    <option value="">æ‰€æœ‰åº“å­˜</option>
                                    <option value="low">ä½åº“å­˜</option>
                                    <option value="normal">æ­£å¸¸åº“å­˜</option>
                                    <option value="out">ç¼ºè´§</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="filterInventory()">æœç´¢</button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary w-100" onclick="resetFilters()">é‡ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>å•†å“åç§°</th>
                                        <th>ç±»åˆ«</th>
                                        <th>å½“å‰åº“å­˜</th>
                                        <th>å•ä»·</th>
                                        <th>æ€»ä»·å€¼</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                            </div>
                                            <div class="mt-2">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>çŠ¶æ€:</strong> <span id="status" class="badge bg-info">å‡†å¤‡å°±ç»ª</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>å•†å“æ•°é‡:</strong> <span id="count" class="badge bg-primary">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¿”å›æŒ‰é’® -->
                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-primary me-2">ğŸ  è¿”å›ä¸»é¡µ</a>
                    <a href="stock-in.html" class="btn btn-success me-2">ğŸ“¦ å•†å“å…¥åº“</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ç›´æ¥é…ç½®ï¼ˆä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶ï¼‰
        const SUPABASE_URL = 'https://kxkdgpqzhqkbfpfpkaww.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4a2RncHF6aHFrYmZwZnBrYXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3ODgwNDgsImV4cCI6MjA3OTM2NDA0OH0.yy4Z4YmG4TP7SYDg0dFBJN1xboraq3Tf1gXzMvlkxyg';
        
        let supabase = null;
        let currentInventory = [];
        let categories = [];
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, type = 'info') {
            const status = document.getElementById('status');
            status.className = `badge bg-${type}`;
            status.textContent = text;
        }
        
        function updateCount(count) {
            document.getElementById('count').textContent = count;
        }
        
        // è·å–åº“å­˜çŠ¶æ€
        function getStockStatus(currentStock, minStock) {
            const stock = currentStock || 0;
            const min = minStock || 0;
            
            if (stock === 0) return 'ç¼ºè´§';
            if (stock <= min) return 'ä½åº“å­˜';
            return 'æ­£å¸¸';
        }
        
        // è·å–çŠ¶æ€æ ·å¼
        function getStatusClass(status) {
            switch (status) {
                case 'ç¼ºè´§': return 'bg-danger';
                case 'ä½åº“å­˜': return 'bg-warning';
                case 'æ­£å¸¸': return 'bg-success';
                default: return 'bg-secondary';
            }
        }
        
        // åŠ è½½å•†å“æ•°æ®
        async function loadInventory() {
            updateStatus('åŠ è½½ä¸­...', 'warning');
            
            try {
                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }
                
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2">æ­£åœ¨æŸ¥è¯¢å•†å“æ•°æ®...</div>
                        </td>
                    </tr>
                `;
                
                console.log('å¼€å§‹æŸ¥è¯¢å•†å“æ•°æ®...');
                
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                    throw error;
                }
                
                console.log('æŸ¥è¯¢æˆåŠŸï¼Œå•†å“æ•°é‡:', products ? products.length : 0);
                currentInventory = products || [];
                
                if (!products || products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <h5>ğŸ“¦ æš‚æ— åº“å­˜æ•°æ®</h5>
                                <p>è¯·å…ˆæ·»åŠ å•†å“æˆ–æ‰§è¡Œæ•°æ®åˆå§‹åŒ–</p>
                                <a href="init-data.html" class="btn btn-primary">ğŸ“Š åˆå§‹åŒ–æ•°æ®</a>
                            </td>
                        </tr>
                    `;
                    updateStatus('æ— æ•°æ®', 'warning');
                    updateCount(0);
                    return;
                }
                
                // æ¸²æŸ“æ•°æ®
                let html = '';
                products.forEach((product, index) => {
                    const totalValue = (product.current_stock || 0) * (product.price || 0);
                    const stockStatus = getStockStatus(product.current_stock, product.min_stock);
                    const statusClass = getStatusClass(stockStatus);
                    
                    html += `
                        <tr>
                            <td><small>${product.sku}</small></td>
                            <td>
                                <strong>${product.name}</strong>
                                ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                            </td>
                            <td><span class="badge bg-info">${product.category || 'æœªåˆ†ç±»'}</span></td>
                            <td>
                                <span class="${statusClass.replace('bg-', 'text-')}">${product.current_stock || 0}</span>
                                ${product.min_stock ? `<br><small class="text-muted">æœ€å°: ${product.min_stock}</small>` : ''}
                            </td>
                            <td>Â¥${(product.price || 0).toFixed(2)}</td>
                            <td><strong>Â¥${totalValue.toFixed(2)}</strong></td>
                            <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">
                                    ç¼–è¾‘
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                updateStatus('åŠ è½½å®Œæˆ', 'success');
                updateCount(products.length);
                console.log('æ•°æ®æ¸²æŸ“å®Œæˆ');
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <h5>âŒ åŠ è½½å¤±è´¥</h5>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="loadInventory()">ğŸ”„ é‡è¯•</button>
                        </td>
                    </tr>
                `;
                updateStatus('åŠ è½½å¤±è´¥', 'danger');
                updateCount(0);
            }
        }
        
        // åŠ è½½ç±»åˆ«æ•°æ®
        async function loadCategories() {
            try {
                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }
                
                const { data: categoryData, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                
                if (error) {
                    console.error('ç±»åˆ«æŸ¥è¯¢é”™è¯¯:', error);
                    return;
                }
                
                categories = categoryData || [];
                const categorySelect = document.getElementById('categoryFilter');
                
                if (categorySelect) {
                    categorySelect.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
                    categories.forEach(category => {
                        categorySelect.innerHTML += `<option value="${category.name}">${category.name}</option>`;
                    });
                }
                
                console.log('ç±»åˆ«åŠ è½½å®Œæˆï¼Œæ•°é‡:', categories.length);
                
            } catch (error) {
                console.error('ç±»åˆ«åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // ç­›é€‰åŠŸèƒ½
        function filterInventory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            let filtered = currentInventory.filter(product => {
                if (searchTerm) {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                        product.sku.toLowerCase().includes(searchTerm);
                    if (!matchesSearch) return false;
                }
                
                if (categoryFilter && product.category !== categoryFilter) {
                    return false;
                }
                
                if (stockFilter) {
                    const status = getStockStatus(product.current_stock, product.min_stock);
                    if (stockFilter === 'low' && status !== 'ä½åº“å­˜') return false;
                    if (stockFilter === 'normal' && status !== 'æ­£å¸¸') return false;
                    if (stockFilter === 'out' && status !== 'ç¼ºè´§') return false;
                }
                
                return true;
            });
            
            // é‡æ–°æ¸²æŸ“ç­›é€‰ç»“æœ
            const tbody = document.getElementById('inventoryTable');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <h5>ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</h5>
                            <p>è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                        </td>
                    </tr>
                `;
                updateCount(0);
                return;
            }
            
            // æ¸²æŸ“ç­›é€‰ç»“æœ
            let html = '';
            filtered.forEach((product, index) => {
                const totalValue = (product.current_stock || 0) * (product.price || 0);
                const stockStatus = getStockStatus(product.current_stock, product.min_stock);
                const statusClass = getStatusClass(stockStatus);
                
                html += `
                    <tr>
                        <td><small>${product.sku}</small></td>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                        </td>
                        <td><span class="badge bg-info">${product.category || 'æœªåˆ†ç±»'}</span></td>
                        <td>
                            <span class="${statusClass.replace('bg-', 'text-')}">${product.current_stock || 0}</span>
                            ${product.min_stock ? `<br><small class="text-muted">æœ€å°: ${product.min_stock}</small>` : ''}
                        </td>
                        <td>Â¥${(product.price || 0).toFixed(2)}</td>
                        <td><strong>Â¥${totalValue.toFixed(2)}</strong></td>
                        <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">
                                ç¼–è¾‘
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateCount(filtered.length);
            updateStatus(`ç­›é€‰å®Œæˆ: ${filtered.length}/${currentInventory.length}`, 'info');
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('stockFilter').value = '';
            
            // é‡æ–°æ¸²æŸ“åŸå§‹æ•°æ®
            if (currentInventory.length > 0) {
                let html = '';
                currentInventory.forEach((product, index) => {
                    const totalValue = (product.current_stock || 0) * (product.price || 0);
                    const stockStatus = getStockStatus(product.current_stock, product.min_stock);
                    const statusClass = getStatusClass(stockStatus);
                    
                    html += `
                        <tr>
                            <td><small>${product.sku}</small></td>
                            <td>
                                <strong>${product.name}</strong>
                                ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                            </td>
                            <td><span class="badge bg-info">${product.category || 'æœªåˆ†ç±»'}</span></td>
                            <td>
                                <span class="${statusClass.replace('bg-', 'text-')}">${product.current_stock || 0}</span>
                                ${product.min_stock ? `<br><small class="text-muted">æœ€å°: ${product.min_stock}</small>` : ''}
                            </td>
                            <td>Â¥${(product.price || 0).toFixed(2)}</td>
                            <td><strong>Â¥${totalValue.toFixed(2)}</strong></td>
                            <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">
                                    ç¼–è¾‘
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('inventoryTable').innerHTML = html;
                updateCount(currentInventory.length);
                updateStatus('æ˜¾ç¤ºå…¨éƒ¨', 'success');
            }
        }
        
        // ç¼–è¾‘å•†å“ï¼ˆç®€å•ç‰ˆæœ¬ï¼Œåªæ˜¾ç¤ºä¿¡æ¯ï¼‰
        function editProduct(productId) {
            const product = currentInventory.find(p => p.id === productId);
            if (product) {
                alert(`ç¼–è¾‘å•†å“åŠŸèƒ½å¾…å¼€å‘\\n\\nå•†å“ä¿¡æ¯:\\nåç§°: ${product.name}\\nSKU: ${product.sku}\\nç±»åˆ«: ${product.category}\\nä»·æ ¼: Â¥${product.price}\\nåº“å­˜: ${product.current_stock}`);
            }
        }
        
        // åˆ é™¤å•†å“ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
        async function deleteProduct(productId) {
            const product = currentInventory.find(p => p.id === productId);
            if (!product) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•†å“"${product.name}"å—ï¼Ÿ\\n\\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadInventory();
                
                alert('å•†å“åˆ é™¤æˆåŠŸï¼');
                
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ åº“å­˜é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ“¦ Supabase SDK çŠ¶æ€: ' + (typeof window.supabase !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'));
            
            // ç­‰å¾…SDKåŠ è½½
            const waitForSDK = () => {
                if (typeof window.supabase !== 'undefined') {
                    console.log('âœ… SDK å·²åŠ è½½ï¼Œå¼€å§‹åŠ è½½æ•°æ®');
                    loadCategories();
                    loadInventory();
                } else {
                    console.log('â³ ç­‰å¾… SDK åŠ è½½...');
                    setTimeout(waitForSDK, 100);
                }
            };
            
            waitForSDK();
        });
    </script>
</body>
</html>