<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜åˆ—è¡¨ - ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">ä»“åº“ç®¡ç†ç³»ç»Ÿ</a>
            <div class="navbar-nav">
                <a class="nav-link" href="index.html">é¦–é¡µ</a>
                <a class="nav-link active" href="inventory-simple.html">åº“å­˜åˆ—è¡¨</a>
                <a class="nav-link" href="stock-in.html">å•†å“å…¥åº“</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2>åº“å­˜åˆ—è¡¨</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success" onclick="loadAllData()">
                                    ğŸ”„ é‡æ–°åŠ è½½æ•°æ®
                                </button>
                                <button class="btn btn-info ms-2" onclick="testConnection()">
                                    ğŸ”— æµ‹è¯•è¿æ¥
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <span id="status" class="badge bg-info">å‡†å¤‡å°±ç»ª</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>å•†å“åç§°</th>
                                        <th>ç±»åˆ«</th>
                                        <th>å½“å‰åº“å­˜</th>
                                        <th>å•ä»·</th>
                                        <th>æ€»ä»·å€¼</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                            </div>
                                            <div class="mt-2">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>ğŸ” è°ƒè¯•ä¿¡æ¯</h6>
                    </div>
                    <div class="card-body">
                        <div id="debug-info" class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            ç­‰å¾…è°ƒè¯•ä¿¡æ¯...
                        </div>
                    </div>
                </div>
                
                <!-- è¿”å›æŒ‰é’® -->
                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-primary me-2">ğŸ  è¿”å›ä¸»é¡µ</a>
                    <a href="direct-test.html" class="btn btn-info me-2">ğŸ”§ æ•°æ®åº“æµ‹è¯•</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ç›´æ¥é…ç½®
        const SUPABASE_URL = 'https://kxkdgpqzhqkbfpfpkaww.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4a2RncHF6aHFrYmZwZnBrYXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3ODgwNDgsImV4cCI6MjA3OTM2NDA0OH0.yy4Z4YmG4TP7SYDg0dFBJN1xboraq3Tf1gXzMvlkxyg';
        
        let supabase = null;
        
        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const debugDiv = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(text, type = 'info') {
            const status = document.getElementById('status');
            status.className = `badge bg-${type}`;
            status.textContent = text;
        }
        
        // åˆå§‹åŒ– Supabase
        async function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK æœªåŠ è½½');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                log('ğŸ”— è¿æ¥URL: ' + SUPABASE_URL);
                return true;
            } catch (error) {
                log('âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'danger');
                return false;
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            updateStatus('æµ‹è¯•è¿æ¥ä¸­...', 'warning');
            log('ğŸ” å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...');
            
            try {
                if (!supabase) {
                    const success = await initSupabase();
                    if (!success) return;
                }
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('âš ï¸ æ•°æ®è¡¨ä¸å­˜åœ¨');
                        updateStatus('æ•°æ®è¡¨ä¸å­˜åœ¨', 'warning');
                    } else {
                        throw error;
                    }
                } else {
                    log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼ç±»åˆ«è¡¨å­˜åœ¨ï¼Œè®°å½•æ•°: ' + (data || 0));
                    updateStatus('è¿æ¥æ­£å¸¸', 'success');
                }
                
            } catch (error) {
                log('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                updateStatus('è¿æ¥å¤±è´¥', 'danger');
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            updateStatus('åŠ è½½æ•°æ®ä¸­...', 'warning');
            log('ğŸ“¦ å¼€å§‹åŠ è½½åº“å­˜æ•°æ®...');
            
            try {
                // åˆå§‹åŒ– Supabase
                if (!supabase) {
                    const success = await initSupabase();
                    if (!success) return;
                }
                
                // åŠ è½½å•†å“æ•°æ®
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2">æ­£åœ¨æŸ¥è¯¢å•†å“æ•°æ®...</div>
                        </td>
                    </tr>
                `;
                
                log('ğŸ” æŸ¥è¯¢å•†å“è¡¨...');
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log('âŒ å•†å“æŸ¥è¯¢é”™è¯¯: ' + JSON.stringify(error));
                    throw error;
                }
                
                log('âœ… å•†å“æŸ¥è¯¢æˆåŠŸï¼Œæ•°é‡: ' + (products ? products.length : 0));
                log('ğŸ“‹ å•†å“æ•°æ®: ' + JSON.stringify(products, null, 2));
                
                if (!products || products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <h5>ğŸ“¦ æš‚æ— åº“å­˜æ•°æ®</h5>
                                <p>è¯·å…ˆæ·»åŠ å•†å“æˆ–æ‰§è¡Œæ•°æ®åˆå§‹åŒ–</p>
                                <a href="init-data.html" class="btn btn-primary">ğŸ“Š åˆå§‹åŒ–æ•°æ®</a>
                            </td>
                        </tr>
                    `;
                    updateStatus('æ— æ•°æ®', 'warning');
                    return;
                }
                
                // æ¸²æŸ“æ•°æ®
                let html = '';
                products.forEach((product, index) => {
                    const totalValue = (product.current_stock || 0) * (product.price || 0);
                    const stockStatus = getStockStatus(product.current_stock, product.min_stock);
                    const statusClass = getStatusClass(stockStatus);
                    
                    html += `
                        <tr>
                            <td><small>${product.sku}</small></td>
                            <td>
                                <strong>${product.name}</strong>
                                ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                            </td>
                            <td><span class="badge bg-info">${product.category || 'æœªåˆ†ç±»'}</span></td>
                            <td>
                                <span class="${statusClass}">${product.current_stock || 0}</span>
                                ${product.min_stock ? `<br><small class="text-muted">æœ€å°: ${product.min_stock}</small>` : ''}
                            </td>
                            <td>Â¥${(product.price || 0).toFixed(2)}</td>
                            <td><strong>Â¥${totalValue.toFixed(2)}</strong></td>
                            <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                updateStatus(`å·²åŠ è½½ ${products.length} ä¸ªå•†å“`, 'success');
                log('ğŸ‰ æ•°æ®æ¸²æŸ“å®Œæˆ');
                
            } catch (error) {
                log('âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                log('âŒ é”™è¯¯å †æ ˆ: ' + error.stack);
                
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <h5>âŒ åŠ è½½å¤±è´¥</h5>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="loadAllData()">ğŸ”„ é‡è¯•</button>
                        </td>
                    </tr>
                `;
                updateStatus('åŠ è½½å¤±è´¥', 'danger');
            }
        }
        
        // è·å–åº“å­˜çŠ¶æ€
        function getStockStatus(currentStock, minStock) {
            const stock = currentStock || 0;
            const min = minStock || 0;
            
            if (stock === 0) return 'ç¼ºè´§';
            if (stock <= min) return 'ä½åº“å­˜';
            return 'æ­£å¸¸';
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'ç¼ºè´§': return 'bg-danger';
                case 'ä½åº“å­˜': return 'bg-warning';
                case 'æ­£å¸¸': return 'bg-success';
                default: return 'bg-secondary';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', async () => {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            log('ğŸ“¦ Supabase SDK çŠ¶æ€: ' + (typeof window.supabase !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'));
            
            // ç­‰å¾…ä¸€ç§’ç¡®ä¿ SDK å®Œå…¨åŠ è½½
            setTimeout(() => {
                loadAllData();
            }, 1000);
        });
    </script>
</body>
</html>